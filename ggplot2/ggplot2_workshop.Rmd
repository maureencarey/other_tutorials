---
title: "TUMI Microbiome/Data Science Weekly Meeting - Introduction to ggplot2"
author: "Maureen Carey"
date: "6/1/2021"
output: html_document
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)

path = "/Users/mac9jc/Documents/Documents - somH12CXJ8GJV40/work/projects/other_tutorials/ggplot2"

knitr::opts_knit$set(root.dir = path)

```

# Get data

Data from: https://github.com/maureencarey/metabolomics

# Prep computational environment

```{r,warning=TRUE, message=FALSE}

library(tidyverse) #dplyr, tidyr
load(.RData)

```

I always like to take a look at the data before I get started. This will clue you in to any potential challenges that may arise or any issues you need to correct, such as:

1. Do you have sufficient N to detect a difference in sample groups? 
2. Is there an outlier that you want to follow up on?
3. Are the data formatted as you expected?
4. Are the data normalized as you expected?

## Basic plotting

For example, let's say you knew Alignment ID 969 was interesting based on previous experiments. What metabolite does Alignment ID 969 represent?

```{r}

interesting_met = met_info[met_info$COMP_ID == 52603,] %>% pull(BIOCHEMICAL)

interesting_met

```

Now let's see the relative abundance of `r interesting_met` in each group.

```{r}


# merge metabolite abundance with group names
interesting_met_abund_w_grps = merge(t(norm_data), sample_info) %>%
  pivot_longer(cols = -c(samples,genetic_background,replicate,drug_treatment),
               names_to = "metabolite", values_to = "abundance")
# plot
ggplot(data = interesting_met_abund_w_grps, aes(x = metabolite, y = abundance, color = drug_treatment)) + # set variables
  geom_boxplot(outlier.shape = NA) + # make it a boxplot, hide outliers
  facet_wrap(~genetic_background) + # split
  theme_minimal() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())

  
```


------

As an aside, I want to talk a bit about plotting in R. The biggest strength of making figures programmatically (as opposed to Excel or Prism, or other approaches that don't use code) is that your figures are 100% reproducible and customizable and all errors are traceable. Making figures in Excel or Prism may be easier to start, but there is no documentation (i.e. code) of what you did. 

`ggplot2`, the package used here, is just one way to do it and my personal favorite. Strengths of `ggplot2` specifically are that its relatively easy to make publication quality figures and many application-focused packages provide even-easier-to-use wrappers for ggplot plotting (think: PCA from Tuesday's workshop with `phyloseq`). My favorite feature of `ggplot2` is how you can layer on new information or plotting approaches. For example, in the plot above, we first specified what data would be used and the x- and y-axes here:

```{r}

p = ggplot(data = interesting_met_abund_w_grps, aes(x = genetic_background, y = `52603`, color = drug_treatment))
p

```

Next, we told the program what type of plot to make (boxplot) so it plotted the data (specified in the first step) using this approach:

```{r}

p = p + geom_boxplot() 
p

```

Third, we layered on points:

```{r}

p = p + geom_point(size = 4) 
p

```

Fourth, we hide the legend:

```{r}

p = p + guides(color = F)
p

```

Fifth, we added statistics:

```{r}

p = p + stat_compare_means(comparisons = my_comparisons, size = 3, method = 't.test')
p

```

We could go even further, e.g. changing the color scheme, background, changing the axis labels, and adding a title:

```{r}

p = p + 
  scale_color_manual(values = c("grey","blue","pink","green")) +
  theme_bw() +
  xlab(NULL) +
  ylab("abundance") +
  ggtitle(paste(interesting_met, "abundance with t.test", sep = " "))
  
p

```

------

Next, let's look at all of the metabolites at once. For example, we'd expect to see a similar range of metabolite abundances in all sample groups. A histogram would be useful for this purpose.

```{r}

# remove Alignment ID column
met_abund_temp = met_abund
met_abund_temp$`Alignment ID` = NULL
# merge metabolite abundance with group names
met_abund_w_grps = rbind(grps,met_abund_temp)
# flip dataframe for easier plotting
df_to_plot = as.data.frame(t(met_abund_w_grps))
# add column headers for easier data access
colnames(df_to_plot)[1] = 'group'
# reorganize data
df_to_plot = tidyr::pivot_longer(df_to_plot, !group, names_to = "metabolite", values_to = "abundance")
# make sure the abundances are read as numbers not as text
df_to_plot$abundance = as.numeric(df_to_plot$abundance)

ggplot(data = df_to_plot, aes(x = abundance, fill = group)) +
  geom_histogram(bins = 100) + scale_x_sqrt() +
  facet_wrap(~group) + guides(fill = F)

```

------

PS - Have questions about that 'pivot_longer' step? It's extremely useful but a little challenging to understand at first. Check this out:^[from https://fromthebottomoftheheap.net/2019/10/25/pivoting-tidily/]

![this is the concept behind pivoting - a way to restructure data for (sometimes) easier plotting](/Users/mac9jc/Documents/work/TUMI/microbiome_course_2021/metabolomics/tidyr-longer-wider.gif)

------
